<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BSCS1B</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:      #f4f3f0;
  --surface: #ffffff;
  --surf2:   #f9f8f6;
  --surf3:   #eeecea;
  --border:  #e0ddd8;
  --text:    #1a1814;
  --sub:     #8a8680;
  --accent:  #5b52e8;
  --acc-lt:  rgba(91,82,232,0.10);
  --green:   #16a35a;
  --grn-lt:  rgba(22,163,90,0.10);
  --amber:   #c47a0a;
  --amb-lt:  rgba(196,122,10,0.10);
  --red:     #dc2626;
  --red-lt:  rgba(220,38,38,0.10);
  --radius:  14px;
  --sidebar-w: 128px;
  --shadow:  0 1px 4px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.05);
}
body.dark {
  --bg:      #0f0f13;
  --surface: #17171d;
  --surf2:   #1e1e26;
  --surf3:   #25252f;
  --border:  #2e2e3a;
  --text:    #f0eee8;
  --sub:     #7a7890;
  --accent:  #6c63ff;
  --acc-lt:  rgba(108,99,255,0.15);
  --green:   #22d07a;
  --grn-lt:  rgba(34,208,122,0.12);
  --amber:   #f5a623;
  --amb-lt:  rgba(245,166,35,0.12);
  --red:     #ff5b5b;
  --red-lt:  rgba(255,91,91,0.12);
  --shadow:  0 1px 4px rgba(0,0,0,0.3), 0 4px 16px rgba(0,0,0,0.2);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.5;overflow-x:hidden;overflow-y:auto;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;letter-spacing:0.5px;}
.logo span{color:var(--accent);}
.topbar-right{display:flex;align-items:center;gap:8px;}
.role-btn{font-family:'Outfit',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;padding:6px 14px;border-radius:20px;border:none;cursor:pointer;transition:all 0.15s;}
.role-btn.admin{background:var(--accent);color:#fff;}
.role-btn.admin-active{background:var(--accent);color:#fff;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.role-btn.user{background:var(--green);color:#0f1a12;}
.role-btn:hover{opacity:0.85;}

/* USER BTN becomes LOGOUT when admin is active */
.role-btn.logout{background:var(--red-lt);color:var(--red);border:1.5px solid var(--red);}
.role-btn.logout:hover{background:var(--red);color:#fff;opacity:1;}

/* ADMIN NAME TAG â€” kept but hidden visually (tag is now the button itself) */
.admin-tag{font-size:11px;font-weight:700;color:var(--accent);background:var(--acc-lt);border:1px solid var(--accent);padding:4px 10px;border-radius:20px;display:none;align-items:center;gap:5px;}
.admin-tag svg{width:11px;height:11px;}
.admin-tag.visible{display:flex;}
.admin-tag.kandiaru-glow{
  color:#a78bfa;
  background:rgba(139,92,246,0.15);
  border-color:#8b5cf6;
  box-shadow:0 0 8px 2px rgba(139,92,246,0.35),0 0 20px 4px rgba(139,92,246,0.15);
  animation:kandiGlow 2.2s ease-in-out infinite;
}
@keyframes kandiGlow{
  0%,100%{box-shadow:0 0 6px 1px rgba(139,92,246,0.3),0 0 14px 3px rgba(139,92,246,0.12);}
  50%    {box-shadow:0 0 12px 4px rgba(139,92,246,0.55),0 0 28px 8px rgba(139,92,246,0.2);}
}
body.dark .admin-tag.kandiaru-glow{
  color:#c4b5fd;
  background:rgba(139,92,246,0.2);
  border-color:#a78bfa;
}

/* Kandiaru glow on admin button when active */
.role-btn.admin-active.kandiaru-btn{
  background: linear-gradient(135deg,#7c3aed,#5b52e8);
  color:#fff;
  box-shadow:0 0 8px 2px rgba(139,92,246,0.45),0 0 20px 4px rgba(139,92,246,0.2);
  animation:kandiGlow 2.2s ease-in-out infinite;
}

/* footer creator chip */
.footer-creator{font-size:10px;font-weight:700;letter-spacing:0.03em;color:var(--accent);background:var(--acc-lt);border:1px solid rgba(91,82,232,0.2);padding:4px 10px;border-radius:20px;display:flex;align-items:center;gap:4px;white-space:nowrap;flex-shrink:0;}
.footer-creator svg{width:10px;height:10px;opacity:0.7;}
body.dark .footer-creator{border-color:rgba(108,99,255,0.3);}

/* Shared Kandiaru glow */
.kandiaru-glow{
  color:#a78bfa !important;
  background:rgba(139,92,246,0.15) !important;
  border-color:#8b5cf6 !important;
  box-shadow:0 0 8px 2px rgba(139,92,246,0.35),0 0 20px 4px rgba(139,92,246,0.15) !important;
  animation:kandiGlow 2.2s ease-in-out infinite !important;
}
body.dark .kandiaru-glow{
  color:#c4b5fd !important;
  background:rgba(139,92,246,0.2) !important;
  border-color:#a78bfa !important;
}

/* DATE BAR */
.date-bar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:6px 12px;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  font-size:12px;
  font-weight:600;
  color:var(--sub);
  letter-spacing:0.05em;
  position:sticky;
  top:57px;
  z-index:99;
}
.date-bar-center{
  flex:1;
  text-align:center;
}
.date-bar-center span{color:var(--text);}
.date-bar-side{
  display:flex;
  align-items:center;
  gap:6px;
  width:80px;
}
.date-bar-side.right{justify-content:flex-end;}

/* Date bar icon buttons */
.icon-bar{
  width:30px;
  height:30px;
  border-radius:9px;
  border:1px solid var(--border);
  background:var(--surf2);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  color:var(--sub);
  transition:all 0.15s;
  flex-shrink:0;
}
.icon-bar:hover{border-color:var(--accent);color:var(--accent);background:var(--acc-lt);}

/* APP BODY */
.app-body{display:flex;flex-direction:column;min-height:calc(100vh - 96px);}

/* TOP PANEL */
.top-panel{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;height:255px;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;gap:6px;padding:12px 8px;}
.filter-btn{display:flex;align-items:center;gap:7px;padding:9px 10px;border-radius:10px;background:var(--surf2);border:1.5px solid transparent;font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;color:var(--sub);cursor:pointer;transition:all 0.18s;text-align:left;width:100%;}
.f-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.f-all      .f-dot{background:var(--accent);}
.f-soon     .f-dot{background:var(--amber);}
.f-today    .f-dot{background:#ea6b0e;}
.f-overdue  .f-dot{background:var(--red);}
.f-done     .f-dot{background:var(--green);}
.filter-btn:hover{background:var(--surf3);color:var(--text);}
.filter-btn.active.f-all    {background:var(--acc-lt);border-color:var(--accent);color:var(--accent);}
.filter-btn.active.f-soon   {background:var(--amb-lt);border-color:var(--amber);color:var(--amber);}
.filter-btn.active.f-today  {background:rgba(234,107,14,0.10);border-color:#ea6b0e;color:#ea6b0e;}
.filter-btn.active.f-overdue{background:var(--red-lt);border-color:var(--red);color:var(--red);}
.filter-btn.active.f-done   {background:var(--grn-lt);border-color:var(--green);color:var(--green);}

@keyframes overdueGlow{
  0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,0);background:var(--surf2);}
  50%{box-shadow:0 0 0 4px rgba(220,38,38,0.18),0 0 14px rgba(220,38,38,0.22);background:var(--red-lt);}
}
body.dark @keyframes overdueGlow{
  0%,100%{box-shadow:0 0 0 0 rgba(255,91,91,0);}
  50%{box-shadow:0 0 0 4px rgba(255,91,91,0.2),0 0 16px rgba(255,91,91,0.28);}
}
.f-overdue.has-overdue{
  animation:overdueGlow 2s ease-in-out infinite;
  border-color:rgba(220,38,38,0.35) !important;
  color:var(--red) !important;
}
.f-overdue.has-overdue .f-dot{background:var(--red);animation:none;}
.f-overdue.has-overdue .filter-count{background:var(--red);color:#fff;}

.filter-count{margin-left:auto;font-size:10px;font-weight:700;background:var(--surf3);color:var(--sub);padding:1px 6px;border-radius:20px;}
.filter-btn.active .filter-count{background:rgba(0,0,0,0.10);color:inherit;}
body.dark .filter-btn.active .filter-count{background:rgba(255,255,255,0.12);}

/* FEATURED */
.featured-panel{flex:1;background:var(--surface);padding:12px 14px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.featured-label{font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--sub);margin-bottom:2px;}

/* NOTES in featured */
.notes-section-label{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--sub);display:flex;align-items:center;gap:6px;margin-top:2px;}
.notes-section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.note-card{background:linear-gradient(135deg,rgba(255,214,0,0.10),rgba(255,180,0,0.06));border:1px solid rgba(196,122,10,0.25);border-left:3px solid var(--amber);border-radius:10px;padding:10px 12px;position:relative;animation:fadeUp 0.2s ease;box-shadow:0 1px 6px rgba(196,122,10,0.08);}
body.dark .note-card{background:rgba(245,166,35,0.07);border-color:rgba(245,166,35,0.2);}
.note-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:5px;}
.note-card-text{font-size:12px;color:var(--text);line-height:1.55;word-break:break-word;overflow-wrap:anywhere;flex:1;}
.note-del-btn{width:20px;height:20px;border-radius:6px;border:none;background:transparent;color:var(--sub);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s;padding:0;}
.note-del-btn:hover{background:var(--red-lt);color:var(--red);}
.note-card-meta{display:flex;align-items:center;gap:6px;margin-top:6px;}
.note-author{font-size:10px;font-weight:700;color:var(--amber);background:var(--amb-lt);padding:2px 7px;border-radius:20px;display:flex;align-items:center;gap:3px;}
.note-author svg{width:9px;height:9px;}
.note-expiry{font-size:10px;color:var(--sub);margin-left:auto;}

/* Add note button (admin only, inside featured panel) */
.add-note-btn{display:none;align-items:center;gap:5px;padding:6px 11px;border-radius:8px;border:1.5px dashed var(--amber);background:transparent;font-family:'Outfit',sans-serif;font-size:11px;font-weight:700;color:var(--amber);cursor:pointer;transition:all 0.15s;width:fit-content;}
.add-note-btn:hover{background:var(--amb-lt);}
.add-note-btn.visible{display:flex;}

.feat-section-divider{display:flex;align-items:center;gap:6px;margin:2px 0;}
.feat-section-divider-line{flex:1;height:1px;background:var(--border);}
.feat-section-divider-label{font-family:'Syne',sans-serif;font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--sub);white-space:nowrap;}
.featured-card{background:var(--surf2);border:1px solid var(--border);border-radius:10px;padding:11px 13px;cursor:pointer;transition:all 0.15s;border-left:3px solid var(--accent);box-shadow:var(--shadow);}
.featured-card:hover{background:var(--surf3);transform:translateX(2px);}
.featured-card.urgent{border-left-color:var(--red);}
.featured-card.soon{border-left-color:var(--amber);}
.fc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.fc-name{font-size:13px;font-weight:600;color:var(--text);}
.fc-meta{font-size:11px;color:var(--sub);display:flex;align-items:center;gap:5px;}
.due-dot{width:5px;height:5px;border-radius:50%;background:var(--red);display:inline-block;}
.no-featured{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--sub);gap:6px;text-align:center;}
.no-featured svg{opacity:0.2;}
.no-featured p{font-size:11px;}

/* ALL TASK HEADER */
.all-task-header{display:flex;align-items:center;padding:9px 16px;background:var(--surface);border-bottom:1px solid var(--border);border-top:1px solid var(--border);flex-shrink:0;gap:8px;}
.all-task-title{font-family:'Syne',sans-serif;font-size:12px;font-weight:800;letter-spacing:0.08em;text-transform:uppercase;white-space:nowrap;}
.task-count-badge{background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;}
.header-right{display:flex;align-items:center;gap:6px;margin-left:auto;}
.search-btn{width:30px;height:30px;border-radius:8px;border:1.5px solid var(--border);background:var(--surf2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--sub);transition:all 0.15s;}
.search-btn:hover{border-color:var(--accent);color:var(--accent);}
.add-task-btn{font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.04em;padding:7px 14px;border-radius:20px;border:1.5px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.add-task-btn:hover{opacity:0.85;}
.search-bar{display:none;padding:0 16px 10px;background:var(--surface);border-bottom:1px solid var(--border);}
.search-bar.open{display:block;}
.search-input{width:100%;background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-family:'Outfit',sans-serif;font-size:13px;color:var(--text);outline:none;transition:border-color 0.15s;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--sub);}

/* TASK LIST AREA */
.task-area{padding:12px 14px;display:flex;flex-direction:column;gap:10px;}

/* DONE SECTION DIVIDER */
.done-divider{display:flex;align-items:center;gap:10px;padding:4px 0 2px;color:var(--sub);}
.done-divider-line{flex:1;height:1px;background:var(--border);}
.done-divider-label{font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;}

/* TASK CARD */
.task-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color 0.2s,box-shadow 0.2s;animation:fadeUp 0.22s ease;box-shadow:var(--shadow);min-width:0;width:100%;}
.task-card:hover{border-color:var(--accent);box-shadow:0 4px 20px rgba(0,0,0,0.10);}
.task-card.expanded{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent);}
.task-card.done-card{opacity:0.52;}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}

/* TOP ROW */
.card-top{display:flex;align-items:center;gap:10px;padding:13px 14px 10px;}
.card-name{flex:1;min-width:0;font-size:14px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-word;}
.task-card.done-card .card-name{text-decoration:line-through;color:var(--sub);}

/* badge */
.badge{font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
.cat-quiz      {background:#ede9fe;color:#5b21b6;}
.cat-project   {background:#dbeafe;color:#1e40af;}
.cat-assignment{background:#fce7f3;color:#9d174d;}
.cat-exam      {background:#fee2e2;color:#991b1b;}
.cat-study     {background:#d1fae5;color:#065f46;}
.cat-review    {background:#a7f3d0;color:#064e3b;}
.cat-output    {background:#fef3c7;color:#78350f;}
.cat-online    {background:#e0f2fe;color:#075985;}
.cat-other     {background:#f1f5f9;color:#475569;}
body.dark .cat-quiz      {background:rgba(109,40,217,0.22);color:#a78bfa;}
body.dark .cat-project   {background:rgba(29,78,216,0.22);color:#60a5fa;}
body.dark .cat-assignment{background:rgba(190,24,93,0.22);color:#f472b6;}
body.dark .cat-exam      {background:rgba(185,28,28,0.22);color:#fca5a5;}
body.dark .cat-study     {background:rgba(6,95,70,0.22);color:#34d399;}
body.dark .cat-review    {background:rgba(5,150,105,0.22);color:#6ee7b7;}
body.dark .cat-output    {background:rgba(133,77,14,0.22);color:#fcd34d;}
body.dark .cat-online    {background:rgba(3,105,161,0.22);color:#7dd3fc;}
body.dark .cat-other     {background:rgba(90,100,116,0.22);color:#94a3b8;}

/* overdue red border */
.task-card.overdue-card{border-color:var(--red) !important;}
.task-card.overdue-card:hover{border-color:var(--red) !important;box-shadow:0 4px 20px rgba(220,38,38,0.18);}

/* STATUS LABEL beside due date */
.status-chip{font-size:10px;font-weight:800;padding:2px 8px;border-radius:20px;letter-spacing:0.04em;text-transform:uppercase;white-space:nowrap;}
.status-chip.overdue{background:var(--red-lt);color:var(--red);}
.status-chip.today  {background:rgba(234,107,14,0.12);color:#ea6b0e;}
.status-chip.soon   {background:var(--amb-lt);color:var(--amber);}
.status-chip.done   {background:var(--grn-lt);color:var(--green);}
body.dark .status-chip.today{background:rgba(234,107,14,0.18);color:#fb923c;}

/* collapsed description */
.card-desc-collapsed{margin:0 14px 10px;background:var(--surf3);border-radius:8px;padding:9px 11px;cursor:pointer;font-size:12px;color:var(--sub);line-height:1.55;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;transition:background 0.15s;border:1px solid transparent;word-break:break-all;overflow-wrap:anywhere;}
.card-desc-collapsed:hover{background:var(--border);color:var(--text);border-color:var(--accent);}
.card-desc-collapsed.no-desc{font-style:italic;opacity:0.6;}

/* CARD FOOTER */
.card-footer{display:flex;align-items:center;padding:0 14px 12px;gap:8px;}
.cfb{font-family:'Outfit',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;padding:5px 12px;border-radius:6px;border:1.5px solid var(--border);background:transparent;color:var(--sub);cursor:pointer;transition:all 0.15s;}
.cfb:hover{background:var(--surf3);color:var(--text);}
.cfb.view{border-radius:20px;border-color:var(--accent);color:var(--accent);padding:5px 20px;}
.cfb.view:hover{background:var(--acc-lt);}
.cfb.del:hover{border-color:var(--red);color:var(--red);}
.cfb.edit:hover{border-color:var(--accent);color:var(--accent);}
.cfb.mark-done{border-radius:20px;border-color:var(--green);color:var(--green);padding:5px 16px;}
.cfb.mark-done:hover{background:var(--grn-lt);}
.cfb.undo-done{border-radius:20px;border-color:var(--amber);color:var(--amber);padding:5px 16px;}
.cfb.undo-done:hover{background:var(--amb-lt);}
.cfb-spacer{flex:1;}

/* expanded body */
.card-expanded-body{display:none;flex-direction:column;}
.task-card.expanded .card-expanded-body{display:flex;}
.task-card.expanded .card-desc-collapsed{display:none;}
.task-card.expanded .card-footer{display:none;}
.card-desc-full{margin:0 14px 12px;background:var(--surf3);border-radius:8px;padding:12px 14px;font-size:13px;color:var(--text);line-height:1.65;max-height:160px;overflow-y:auto;overflow-x:hidden;border:1px solid var(--border);word-break:break-all;overflow-wrap:anywhere;white-space:pre-wrap;}
.card-desc-full::-webkit-scrollbar{width:3px;}
.card-desc-full::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* image strip */
.card-images{display:flex;gap:8px;padding:0 14px 12px;overflow-x:auto;}
.card-images::-webkit-scrollbar{height:3px;}
.card-images::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.card-img-thumb{width:80px;height:66px;border-radius:8px;flex-shrink:0;background:var(--surf3);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--sub);font-size:10px;font-weight:600;overflow:hidden;cursor:pointer;transition:border-color 0.15s;}
.card-img-thumb:hover{border-color:var(--accent);}
.card-img-thumb img{width:100%;height:100%;object-fit:cover;}
.add-img-btn{width:80px;height:66px;border-radius:8px;flex-shrink:0;background:transparent;border:1.5px dashed var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--sub);font-size:9px;font-weight:600;cursor:pointer;gap:3px;transition:border-color 0.15s;}
.add-img-btn:hover{border-color:var(--accent);color:var(--accent);}
.card-footer-exp{display:flex;align-items:center;gap:8px;margin:0 14px;padding:10px 0 12px;border-top:1px solid var(--border);}

/* empty */
.empty-state{text-align:center;padding:40px 20px;color:var(--sub);}
.empty-state svg{opacity:0.2;margin-bottom:10px;}
.empty-state h3{font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px;}
.empty-state p{font-size:12px;}

/* COMPLETION ANIMATION */
@keyframes taskDone{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
@keyframes checkPop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}60%{transform:translate(-50%,-50%) scale(1.2);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
@keyframes confPop{0%{transform:translateY(0) scale(0);opacity:1}100%{transform:translateY(-36px) scale(1);opacity:0}}
.task-completing{animation:taskDone 0.5s ease;position:relative;}
.completion-chk{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);width:44px;height:44px;background:var(--green);border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10;animation:checkPop 0.5s ease forwards;pointer-events:none;}
.completion-chk svg{width:22px;height:22px;stroke:#0f1a12;stroke-width:3;fill:none;}
.conf-p{position:absolute;width:6px;height:6px;border-radius:50%;animation:confPop 0.65s ease forwards;pointer-events:none;z-index:9;}

/* ADD/EDIT MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:flex-end;justify-content:center;z-index:200;backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity 0.2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px 20px 0 0;padding:22px 22px 30px;width:100%;max-width:520px;transform:translateY(40px);transition:transform 0.25s ease;max-height:92vh;overflow-y:auto;box-shadow:0 -8px 40px rgba(0,0,0,0.15);}
.overlay.open .modal{transform:translateY(0);}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 18px;}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:18px;color:var(--text);}
.form-group{margin-bottom:13px;}
.form-label{display:block;font-size:11px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--sub);margin-bottom:5px;}
.form-control{width:100%;background:var(--surf2);border:1.5px solid var(--border);border-radius:10px;padding:9px 13px;font-family:'Outfit',sans-serif;font-size:14px;color:var(--text);outline:none;transition:border-color 0.15s;}
.form-control:focus{border-color:var(--accent);}
.form-control::placeholder{color:var(--sub);}
textarea.form-control{resize:vertical;min-height:70px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-actions{display:flex;gap:10px;margin-top:16px;}
.btn-cancel{flex:1;background:var(--surf2);border:1.5px solid var(--border);border-radius:10px;padding:11px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;color:var(--sub);cursor:pointer;transition:all 0.15s;}
.btn-cancel:hover{color:var(--text);border-color:var(--text);}
.btn-save{flex:2;background:var(--accent);border:none;border-radius:10px;padding:11px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;color:#fff;cursor:pointer;transition:opacity 0.15s;}
.btn-save:hover{opacity:0.88;}

/* ADMIN LOGIN MODAL */
.login-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:300;backdrop-filter:blur(8px);opacity:0;pointer-events:none;transition:opacity 0.25s;}
.login-overlay.open{opacity:1;pointer-events:all;}
.login-modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px 28px 26px;width:calc(100% - 32px);max-width:380px;transform:scale(0.95) translateY(8px);transition:transform 0.25s ease,opacity 0.25s;box-shadow:0 20px 60px rgba(0,0,0,0.25);}
.login-overlay.open .login-modal{transform:scale(1) translateY(0);}
.login-header{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:24px;}
.login-icon{width:52px;height:52px;border-radius:16px;background:var(--acc-lt);border:1.5px solid var(--accent);display:flex;align-items:center;justify-content:center;color:var(--accent);}
.login-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--text);}
.login-sub{font-size:12px;color:var(--sub);text-align:center;}
.login-form-group{margin-bottom:12px;}
.login-label{display:block;font-size:11px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--sub);margin-bottom:5px;}
.login-input{width:100%;background:var(--surf2);border:1.5px solid var(--border);border-radius:10px;padding:10px 13px;font-family:'Outfit',sans-serif;font-size:14px;color:var(--text);outline:none;transition:border-color 0.15s;}
.login-input:focus{border-color:var(--accent);}
.login-input::placeholder{color:var(--sub);}
.login-error{font-size:11px;color:var(--red);background:var(--red-lt);border:1px solid rgba(220,38,38,0.2);border-radius:8px;padding:8px 12px;margin-bottom:12px;display:none;align-items:center;gap:6px;}
.login-error.show{display:flex;}
.login-actions{display:flex;gap:10px;margin-top:16px;}
.btn-login-cancel{flex:1;background:var(--surf2);border:1.5px solid var(--border);border-radius:10px;padding:11px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;color:var(--sub);cursor:pointer;transition:all 0.15s;}
.btn-login-cancel:hover{color:var(--text);border-color:var(--text);}
.btn-login-go{flex:2;background:var(--accent);border:none;border-radius:10px;padding:11px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;color:#fff;cursor:pointer;transition:opacity 0.15s;}
.btn-login-go:hover{opacity:0.88;}
.shake{animation:shake 0.38s ease;}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-5px)}40%{transform:translateX(5px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

/* LIGHTBOX */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s;}
.lightbox.open{opacity:1;pointer-events:all;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:10px;}
.lb-close{position:absolute;top:20px;right:24px;background:none;border:none;color:#fff;font-size:26px;cursor:pointer;opacity:0.7;}
.lb-close:hover{opacity:1;}

/* DELETE CONFIRM MODAL */
.del-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:400;backdrop-filter:blur(8px);opacity:0;pointer-events:none;transition:opacity 0.2s;}
.del-overlay.open{opacity:1;pointer-events:all;}
.del-modal{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:28px 26px 24px;width:calc(100% - 40px);max-width:320px;text-align:center;transform:scale(0.92) translateY(8px);transition:transform 0.22s ease;box-shadow:0 20px 60px rgba(0,0,0,0.22);}
.del-overlay.open .del-modal{transform:scale(1) translateY(0);}
.del-icon{width:52px;height:52px;border-radius:14px;background:var(--red-lt);border:1.5px solid rgba(220,38,38,0.25);display:flex;align-items:center;justify-content:center;color:var(--red);margin:0 auto 14px;}
.del-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:var(--text);margin-bottom:6px;}
.del-sub{font-size:12px;color:var(--sub);margin-bottom:22px;line-height:1.5;}
.del-actions{display:flex;gap:10px;}
.del-btn-cancel{flex:1;background:var(--surf2);border:1.5px solid var(--border);border-radius:10px;padding:10px;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;color:var(--sub);cursor:pointer;transition:all 0.15s;}
.del-btn-cancel:hover{color:var(--text);border-color:var(--text);}
.del-btn-confirm{flex:1;background:var(--red);border:none;border-radius:10px;padding:10px;font-family:'Outfit',sans-serif;font-size:13px;font-weight:700;color:#fff;cursor:pointer;transition:opacity 0.15s;}
.del-btn-confirm:hover{opacity:0.85;}

/* CREDITS WATERMARK */
.credits-badge{position:fixed;bottom:14px;right:16px;font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.08em;color:var(--sub);opacity:0.38;pointer-events:none;user-select:none;z-index:50;}
body.dark .credits-badge{opacity:0.22;}

input[type=file]{display:none;}
</style>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar">
  <div class="logo">BSC<span>S1B</span></div>
  <div class="topbar-right">
    <!-- Admin name tag (kept for legacy, hidden) -->
    <div class="admin-tag" id="adminTag" style="display:none!important;">
      <span id="adminTagIcon"></span>
      <span id="adminTagName"></span>
    </div>

    <!-- Admin button: shows title+name when logged in -->
    <button class="role-btn admin" id="adminBtn" onclick="clickAdminBtn()">Admin</button>
    <!-- User button â†’ becomes Logout when admin active -->
    <button class="role-btn user" id="userBtn" onclick="userBtnClick()">User</button>
  </div>
</header>

<!-- DATE BAR (with fullscreen left, dark mode right) -->
<div class="date-bar" id="dateBar">
  <!-- LEFT: Fullscreen -->
  <div class="date-bar-side">
    <button class="icon-bar" id="fullscreenBtn" onclick="toggleFullscreen()" title="Fullscreen">
      <svg id="fsIcon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <path d="M8 3H5a2 2 0 0 0-2 2v3"/>
        <path d="M21 8V5a2 2 0 0 0-2-2h-3"/>
        <path d="M3 16v3a2 2 0 0 0 2 2h3"/>
        <path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
      </svg>
    </button>
  </div>

  <!-- CENTER: Date -->
  <div class="date-bar-center" id="dateBarText"></div>

  <!-- RIGHT: Dark mode -->
  <div class="date-bar-side right">
    <button class="icon-bar" onclick="toggleTheme()" title="Toggle Theme" id="themeBtn">
      <svg id="themeIcon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>
  </div>
</div>

<!-- APP BODY -->
<div class="app-body">

  <!-- TOP PANEL -->
  <div class="top-panel">
    <div class="sidebar">
      <button class="filter-btn f-all active" onclick="setFilter('all')">
        <span class="f-dot"></span>All<span class="filter-count" id="cnt-all">0</span>
      </button>
      <button class="filter-btn f-soon" onclick="setFilter('soon')">
        <span class="f-dot"></span>Soon<span class="filter-count" id="cnt-soon">0</span>
      </button>
      <button class="filter-btn f-today" onclick="setFilter('today')">
        <span class="f-dot"></span>Today<span class="filter-count" id="cnt-today">0</span>
      </button>
      <button class="filter-btn f-overdue" onclick="setFilter('overdue')">
        <span class="f-dot"></span>Overdue<span class="filter-count" id="cnt-overdue">0</span>
      </button>
      <button class="filter-btn f-done" onclick="setFilter('done')">
        <span class="f-dot"></span>Done<span class="filter-count" id="cnt-done">0</span>
      </button>
    </div>
    <div class="featured-panel">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="featured-label">Featured</div>
        <button class="add-note-btn" id="addNoteBtn" onclick="openNoteModal()">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Note
        </button>
      </div>
      <div id="notesList"></div>
      <div id="featuredList"></div>
    </div>
  </div>

  <!-- ALL TASK HEADER -->
  <div class="all-task-header">
    <span class="all-task-title">All Tasks</span>
    <span class="task-count-badge" id="taskCountBadge">0</span>
    <div class="header-right">
      <button class="search-btn" onclick="toggleSearch()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </button>
      <button class="add-task-btn" id="addBtn" onclick="openModal()" title="Add Task">
        + Add Task
      </button>
    </div>
  </div>

  <!-- SEARCH BAR -->
  <div class="search-bar" id="searchBar">
    <input class="search-input" id="searchInput" type="text" placeholder="Search tasksâ€¦" oninput="renderTasks()"/>
  </div>

  <!-- TASK LIST -->
  <div class="task-area" id="taskArea"></div>

</div>

<!-- ADD/EDIT TASK MODAL -->
<div class="overlay" id="overlay" onclick="handleOverlay(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">Add Task</div>
    <div class="form-group">
      <label class="form-label">Task Name *</label>
      <input class="form-control" id="fName" type="text" placeholder="e.g. Submit Chemistry quiz"/>
    </div>
    <div class="form-group">
      <label class="form-label">Category</label>
      <select class="form-control" id="fCat">
        <option value="quiz">Quiz</option><option value="project">Project</option>
        <option value="assignment">Assignment</option><option value="exam">Exam</option>
        <option value="study">Study</option><option value="review">Review</option>
        <option value="output">Output</option><option value="online">Online Class</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Due Date</label><input class="form-control" id="fDate" type="date"/></div>
      <div class="form-group"><label class="form-label">Due Time</label><input class="form-control" id="fTime" type="time"/></div>
    </div>
    <div class="form-group">
      <label class="form-label">Description / Notes</label>
      <textarea class="form-control" id="fNotes" placeholder="Details, links, remindersâ€¦"></textarea>
    </div>
    <div class="form-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="login-overlay" id="loginOverlay" onclick="handleLoginOverlay(event)">
  <div class="login-modal" id="loginModal">
    <div class="login-header">
      <div class="login-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
          <rect x="3" y="11" width="18" height="11" rx="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
      </div>
      <div class="login-title">Admin Access</div>
      <div class="login-sub">Enter your credentials to manage tasks</div>
    </div>

    <div class="login-error" id="loginError">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span id="loginErrorMsg">Invalid username or password.</span>
    </div>

    <div class="login-form-group">
      <label class="login-label">Username</label>
      <input class="login-input" id="loginUser" type="text" placeholder="Enter username" autocomplete="username"/>
    </div>
    <div class="login-form-group">
      <label class="login-label">Password</label>
      <input class="login-input" id="loginPass" type="password" placeholder="Enter password" autocomplete="current-password" onkeydown="if(event.key==='Enter')attemptLogin()"/>
    </div>

    <div class="login-actions">
      <button class="btn-login-cancel" onclick="closeLoginModal()">Cancel</button>
      <button class="btn-login-go" onclick="attemptLogin()">Login â†’</button>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lb-close" onclick="closeLightbox()">âœ•</button>
  <img id="lightboxImg" src="" alt=""/>
</div>

<!-- DELETE CONFIRM MODAL -->
<div class="del-overlay" id="delOverlay">
  <div class="del-modal" id="delModal">
    <div class="del-icon">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
      </svg>
    </div>
    <div class="del-title">Delete Task?</div>
    <div class="del-sub" id="delSubText">This action cannot be undone.</div>
    <div class="del-actions">
      <button class="del-btn-cancel" onclick="closeDelModal()">Cancel</button>
      <button class="del-btn-confirm" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- ADD NOTE MODAL -->
<div class="overlay" id="noteOverlay" onclick="handleNoteOverlay(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ðŸ“Œ Post a Note</div>
    <div class="form-group">
      <label class="form-label">Note Content *</label>
      <textarea class="form-control" id="nText" placeholder="Write your announcement or reminder hereâ€¦" style="min-height:90px;"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Visible For</label>
      <select class="form-control" id="nExpiry">
        <option value="1">1 Day</option>
        <option value="3" selected>3 Days</option>
        <option value="7">1 Week</option>
      </select>
    </div>
    <div class="form-actions">
      <button class="btn-cancel" onclick="closeNoteModal()">Cancel</button>
      <button class="btn-save" onclick="saveNote()" style="background:var(--amber);">Post Note</button>
    </div>
  </div>
</div>

<!-- CREDITS -->
<div class="credits-badge">
  <svg width="14" height="14" viewBox="0 0 24 30" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle;margin-right:4px;">
    <polygon points="3,6 5.5,1 8,6 5.5,9" fill="currentColor"/>
    <line x1="2" y1="2" x2="9" y2="8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
    <polygon points="16,6 18.5,1 21,6 18.5,9" fill="currentColor"/>
    <line x1="15" y1="2" x2="22" y2="8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
    <path d="M 0,13 Q 5,9 12,9 Q 19,9 24,13 Q 22,30 12,30 Q 2,30 0,13 Z" fill="currentColor" opacity="0.13"/>
    <path d="M 0,13 Q 5,9 12,9 Q 19,9 24,13" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
    <path d="M 0,13 Q 2,30 12,30 Q 22,30 24,13" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
    <polyline points="1,13 3,20 5,13 7,21 9,13 11,22.5 13,13 15,21 17,13 19,20 21,13 23,13"
      stroke="currentColor" stroke-width="1.3" fill="none" stroke-linejoin="miter" stroke-linecap="square"/>
  </svg>Admin Kandiaru
</div>

<input type="file" id="imgUpload" accept="image/*" multiple onchange="handleImgUpload(event)"/>

<script>
const KEY='taskhub-v4';
const NOTES_KEY='taskhub-notes-v1';
const CAT_LABELS={quiz:'Quiz',project:'Project',assignment:'Assignment',exam:'Exam',study:'Study',review:'Review',output:'Output',online:'Online Class',other:'Other'};

const ADMINS=[
  {username:'Francy',   password:'123BSCS1B'},
  {username:'Carina',   password:'321BSCS1B'},
  {username:'Kandiaru', password:'ONEABOVEALL'},
];

const ADMIN_TITLES={
  Francy:  'P.I.O. Francy',
  Carina:  'Mayor Carina',
  Kandiaru:'Admin Kandiaru',
};

let tasks=[], notes=[], editId=null, uploadTargetId=null;
let activeFilter='all', currentRole='user', currentAdminName=null, isDark=false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAdminTitle(name){ return ADMIN_TITLES[name]||name; }

function getAdminIcon(name,size=10){
  if(name==='Kandiaru'){
    return `<svg width="${size}" height="${size}" viewBox="0 0 24 30" fill="none" xmlns="http://www.w3.org/2000/svg">
      <polygon points="3,6 5.5,1 8,6 5.5,9" fill="currentColor"/>
      <line x1="2" y1="2" x2="9" y2="8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
      <polygon points="16,6 18.5,1 21,6 18.5,9" fill="currentColor"/>
      <line x1="15" y1="2" x2="22" y2="8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
      <path d="M 0,13 Q 5,9 12,9 Q 19,9 24,13 Q 22,30 12,30 Q 2,30 0,13 Z" fill="currentColor" opacity="0.13"/>
      <path d="M 0,13 Q 5,9 12,9 Q 19,9 24,13" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
      <path d="M 0,13 Q 2,30 12,30 Q 22,30 24,13" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>
      <polyline points="1,13 3,20 5,13 7,21 9,13 11,22.5 13,13 15,21 17,13 19,20 21,13 23,13"
        stroke="currentColor" stroke-width="1.3" fill="none" stroke-linejoin="miter" stroke-linecap="square"/>
    </svg>`;
  }
  return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/><path d="M20 21a8 8 0 1 0-16 0"/></svg>`;
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function isOverdue(t){return t.date&&!t.done&&new Date(t.date+'T'+(t.time||'23:59'))<new Date();}
function isToday(t){
  if(!t.date||t.done)return false;
  const diff=(new Date(t.date+'T'+(t.time||'23:59'))-new Date())/(1000*60*60*24);
  return diff>=0&&diff<1;
}
function isDueSoon(t){
  if(!t.date||t.done)return false;
  const diff=(new Date(t.date+'T'+(t.time||'23:59'))-new Date())/(1000*60*60*24);
  return diff>=1&&diff<=2;
}
function fmtDue(date,time){
  if(!date)return null;
  const lbl=new Date(date+'T00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if(!time)return lbl;
  const [h,m]=time.split(':');const hr=+h;
  return `${lbl} ${(hr%12)||12}:${m}${hr>=12?'pm':'am'}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function load(){
  try{const s=localStorage.getItem(KEY);if(s)tasks=JSON.parse(s);}catch(e){tasks=[];}
  try{const n=localStorage.getItem(NOTES_KEY);if(n)notes=JSON.parse(n);}catch(e){notes=[];}
  pruneExpiredNotes();
  renderAll();
}
function persist(){
  try{localStorage.setItem(KEY,JSON.stringify(tasks));}catch(e){}
  try{localStorage.setItem(NOTES_KEY,JSON.stringify(notes));}catch(e){}
}
function pruneExpiredNotes(){
  const now=Date.now();
  notes=notes.filter(n=>n.expiresAt>now);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ROLE / AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clickAdminBtn(){
  if(currentRole==='admin')return;
  openLoginModal();
}

function userBtnClick(){
  if(currentRole==='admin') logout();
}

function logout(){
  currentRole='user';
  currentAdminName=null;
  updateRoleUI();
  renderAll();
}

function updateRoleUI(){
  const isAdmin=currentRole==='admin';
  const adminBtn=document.getElementById('adminBtn');

  if(isAdmin){
    // Show title + name on the Admin button, icon + text
    const title=getAdminTitle(currentAdminName);
    const icon=getAdminIcon(currentAdminName,11);
    adminBtn.innerHTML=`${icon}<span style="margin-left:4px;">${title}</span>`;
    adminBtn.className='role-btn admin-active'+(currentAdminName==='Kandiaru'?' kandiaru-btn':'');
    adminBtn.style.display='flex';
    adminBtn.style.alignItems='center';
    adminBtn.style.gap='4px';
  } else {
    adminBtn.innerHTML='Admin';
    adminBtn.className='role-btn admin';
    adminBtn.style.opacity='0.4';
    adminBtn.style.display='';
    adminBtn.style.alignItems='';
    adminBtn.style.gap='';
  }

  // User button â†’ Logout when admin active
  const userBtn=document.getElementById('userBtn');
  if(isAdmin){
    userBtn.textContent='Logout';
    userBtn.className='role-btn logout';
  } else {
    userBtn.textContent='User';
    userBtn.className='role-btn user';
    userBtn.style.opacity='1';
  }

  document.getElementById('addBtn').style.display=isAdmin?'block':'none';
  document.getElementById('addNoteBtn').classList.toggle('visible',isAdmin);
}

// LOGIN MODAL
function openLoginModal(){
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginError').classList.remove('show');
  document.getElementById('loginOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('loginUser').focus(),120);
}
function closeLoginModal(){
  document.getElementById('loginOverlay').classList.remove('open');
}
function handleLoginOverlay(e){
  if(e.target===document.getElementById('loginOverlay'))closeLoginModal();
}

function attemptLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  const match=ADMINS.find(a=>a.username===u&&a.password===p);
  if(match){
    currentRole='admin';
    currentAdminName=match.username;
    closeLoginModal();
    updateRoleUI();
    renderAll();
  } else {
    const errEl=document.getElementById('loginError');
    errEl.classList.add('show');
    document.getElementById('loginErrorMsg').textContent='Invalid username or password.';
    document.getElementById('loginModal').classList.add('shake');
    setTimeout(()=>document.getElementById('loginModal').classList.remove('shake'),400);
    document.getElementById('loginPass').value='';
    document.getElementById('loginPass').focus();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FULLSCREEN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFullscreen(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().catch(()=>{});
  } else {
    document.exitFullscreen().catch(()=>{});
  }
}

document.addEventListener('fullscreenchange',()=>{
  const icon=document.getElementById('fsIcon');
  if(document.fullscreenElement){
    // Show compress/exit icon
    icon.innerHTML=`<path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/>`;
  } else {
    // Show expand icon
    icon.innerHTML=`<path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>`;
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  THEME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme(){
  isDark=!isDark;
  document.body.classList.toggle('dark',isDark);
  const icon=document.getElementById('themeIcon');
  if(isDark){
    icon.innerHTML='<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  } else {
    icon.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILTER / SEARCH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f){
  activeFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.f-'+f).classList.add('active');
  renderAll();
}
function toggleSearch(){
  document.getElementById('searchBar').classList.toggle('open');
  if(document.getElementById('searchBar').classList.contains('open'))
    setTimeout(()=>document.getElementById('searchInput').focus(),50);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(){updateCounts();renderFeatured();renderTasks();}

function updateCounts(){
  const setBadge=(id,val)=>{
    const el=document.getElementById(id);
    el.textContent=val;
    el.style.display=val>0?'':'none';
  };
  setBadge('cnt-all',    tasks.length);
  setBadge('cnt-today',  tasks.filter(t=>isToday(t)).length);
  setBadge('cnt-soon',   tasks.filter(t=>isDueSoon(t)).length);
  const overdueCount=tasks.filter(t=>isOverdue(t)).length;
  setBadge('cnt-overdue',overdueCount);
  setBadge('cnt-done',   tasks.filter(t=>t.done).length);
  document.querySelector('.f-overdue').classList.toggle('has-overdue',overdueCount>0);
}

function renderFeatured(){
  pruneExpiredNotes();

  const notesEl=document.getElementById('notesList');
  if(notes.length){
    let notesHTML=`<div class="feat-section-divider"><div class="feat-section-divider-line"></div><span class="feat-section-divider-label">ðŸ“Œ Notes (${notes.length})</span><div class="feat-section-divider-line"></div></div>`;
    notesHTML+=notes.map(n=>{
      const now=Date.now();
      const msLeft=n.expiresAt-now;
      const daysLeft=Math.ceil(msLeft/(1000*60*60*24));
      const expiryLabel=daysLeft<=1?'Expires today':`Expires in ${daysLeft}d`;
      const canDel=currentRole==='admin'&&currentAdminName===n.author;
      const delBtn=canDel
        ?`<button class="note-del-btn" onclick="deleteNote('${n.id}')" title="Delete note"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>`
        :'';
      return `<div class="note-card">
        <div class="note-card-top">
          <div class="note-card-text">${esc(n.text)}</div>
          ${delBtn}
        </div>
        <div class="note-card-meta">
          <span class="note-author${n.author==='Kandiaru'?' kandiaru-glow':''}">${getAdminIcon(n.author,9)}${esc(getAdminTitle(n.author))}</span>
        </div>
      </div>`;
    }).join('');
    notesEl.innerHTML=notesHTML;
  } else {
    notesEl.innerHTML='';
  }

  const el=document.getElementById('featuredList');
  const feat=tasks.filter(t=>!t.done&&(isOverdue(t)||isToday(t)||isDueSoon(t)))
    .sort((a,b)=>{
      const da=a.date?new Date(a.date+'T'+(a.time||'23:59')):new Date('9999');
      const db=b.date?new Date(b.date+'T'+(b.time||'23:59')):new Date('9999');
      return da-db;
    }).slice(0,4);

  if(!feat.length&&!notes.length){
    el.innerHTML=`<div class="no-featured"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.3"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><p>All caught up!</p></div>`;
    return;
  }
  if(!feat.length){el.innerHTML='';return;}

  const fOverdue=feat.filter(t=>isOverdue(t));
  const fToday=feat.filter(t=>isToday(t)&&!isOverdue(t));
  const fSoon=feat.filter(t=>isDueSoon(t));

  let html='';
  const buildFeatCards=(arr,labelText,labelColor)=>{
    if(!arr.length)return '';
    let out=`<div class="feat-section-divider"><div class="feat-section-divider-line" style="background:${labelColor}33"></div><span class="feat-section-divider-label" style="color:${labelColor}">${labelText}</span><div class="feat-section-divider-line" style="background:${labelColor}33"></div></div>`;
    out+=arr.map(t=>{
      const due=fmtDue(t.date,t.time);
      const over=isOverdue(t),tod=isToday(t)&&!over;
      return `<div class="featured-card ${over?'urgent':tod?'soon':''}" onclick="expandCard('${t.id}')">
        <div class="fc-top"><span class="fc-name">${esc(t.name)}</span><span class="badge cat-${t.category}">${CAT_LABELS[t.category]}</span></div>
        <div class="fc-meta">${due?`<span>${over?'<span class="due-dot"></span>':''} ${esc(due)}</span>`:''}</div>
      </div>`;
    }).join('');
    return out;
  };

  html+=buildFeatCards(fOverdue,'Overdue','#dc2626');
  html+=buildFeatCards(fToday,'Today','#ea6b0e');
  html+=buildFeatCards(fSoon,'Soon','#c47a0a');
  el.innerHTML=html;
}

function renderTasks(){
  const search=(document.getElementById('searchInput').value||'').toLowerCase();
  let list=tasks.filter(t=>{
    if(activeFilter==='done'   &&!t.done)return false;
    if(activeFilter==='today'  &&(!isToday(t)||t.done))return false;
    if(activeFilter==='soon'   &&(!isDueSoon(t)||t.done))return false;
    if(activeFilter==='overdue'&&(!isOverdue(t)||t.done))return false;
    if(search&&!t.name.toLowerCase().includes(search)&&!(t.notes||'').toLowerCase().includes(search))return false;
    return true;
  });

  const upcoming=list.filter(t=>!t.done&&!isOverdue(t)).sort((a,b)=>{
    const da=a.date?new Date(a.date+'T'+(a.time||'23:59')):new Date('9999');
    const db=b.date?new Date(b.date+'T'+(b.time||'23:59')):new Date('9999');
    return da-db;
  });
  const overdue=list.filter(t=>!t.done&&isOverdue(t)).sort((a,b)=>{
    const da=a.date?new Date(a.date+'T'+(a.time||'23:59')):new Date('9999');
    const db=b.date?new Date(b.date+'T'+(b.time||'23:59')):new Date('9999');
    return da-db;
  });
  const done=list.filter(t=>t.done).sort((a,b)=>{
    const da=a.date?new Date(a.date+'T'+(a.time||'23:59')):new Date('9999');
    const db=b.date?new Date(b.date+'T'+(b.time||'23:59')):new Date('9999');
    return da-db;
  });

  const tb=document.getElementById('taskCountBadge');
  tb.textContent=list.length;
  tb.style.display=list.length>0?'':'none';
  const el=document.getElementById('taskArea');

  if(!list.length){
    el.innerHTML=`<div class="empty-state"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.3"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M9 12h6M12 9v6"/></svg><h3>${tasks.length?'No tasks match':'Nothing here yet'}</h3><p>${tasks.length?'Try a different filter.':'Tap + to add your first task.'}</p></div>`;
    return;
  }

  let html=upcoming.map(t=>buildCard(t)).join('');

  if(done.length){
    html+=`<div class="done-divider"><div class="done-divider-line"></div><span class="done-divider-label">Completed (${done.length})</span><div class="done-divider-line"></div></div>`;
    html+=done.map(t=>buildCard(t)).join('');
  }

  if(overdue.length){
    html+=`<div class="done-divider overdue-divider"><div class="done-divider-line" style="background:rgba(220,38,38,0.3)"></div><span class="done-divider-label" style="color:var(--red)">âš  Overdue (${overdue.length})</span><div class="done-divider-line" style="background:rgba(220,38,38,0.3)"></div></div>`;
    html+=overdue.map(t=>buildCard(t)).join('');
  }

  el.innerHTML=html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BUILD CARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCard(t){
  const over=isOverdue(t);
  const tod=isToday(t);
  const soon=isDueSoon(t);
  const due=fmtDue(t.date,t.time);
  const notes=t.notes||'';
  const imgs=t.images||[];

  let statusChip='';
  if(t.done)                       statusChip=`<span class="status-chip done">Done</span>`;
  else if(over)                    statusChip=`<span class="status-chip overdue">Overdue</span>`;
  else if(tod)                     statusChip=`<span class="status-chip today">Today</span>`;
  else if(soon)                    statusChip=`<span class="status-chip soon">Soon</span>`;

  const creatorChip=t.createdBy
    ? `<span class="footer-creator${t.createdBy==='Kandiaru'?' kandiaru-glow':''}">${getAdminIcon(t.createdBy,10)}${esc(getAdminTitle(t.createdBy))}</span>`
    : '';

  const imgHTML=imgs.map((src,i)=>`<div class="card-img-thumb" onclick="openLightbox('${t.id}',${i})"><img src="${esc(src)}" alt=""/></div>`).join('');
  const addImgBtn=currentRole==='admin'?`<button class="add-img-btn" onclick="triggerImgUpload('${t.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add</button>`:'';

  let collapsedFooter;
  if(currentRole==='admin'){
    collapsedFooter=`<div class="card-footer">
      <button class="cfb edit" onclick="event.stopPropagation();openModal('${t.id}')">Edit</button>
      <button class="cfb del"  onclick="event.stopPropagation();deleteTask('${t.id}')">Delete</button>
      <span class="cfb-spacer"></span>
      ${creatorChip}
      <button class="cfb view" onclick="event.stopPropagation();expandCard('${t.id}')">View</button>
    </div>`;
  } else {
    const doneBtn=t.done
      ? `<button class="cfb undo-done" onclick="event.stopPropagation();toggleDone('${t.id}')">â†© Undo</button>`
      : `<button class="cfb mark-done" onclick="event.stopPropagation();toggleDone('${t.id}')">âœ“ Mark Done</button>`;
    collapsedFooter=`<div class="card-footer">
      ${doneBtn}
      <span class="cfb-spacer"></span>
      ${creatorChip}
      <button class="cfb view" onclick="event.stopPropagation();expandCard('${t.id}')">View</button>
    </div>`;
  }

  let expandedFooter;
  if(currentRole==='admin'){
    expandedFooter=`<div class="card-footer-exp">
      <button class="cfb edit" onclick="event.stopPropagation();openModal('${t.id}')">Edit</button>
      <button class="cfb del"  onclick="event.stopPropagation();deleteTask('${t.id}')">Delete</button>
      <span class="cfb-spacer"></span>
      ${creatorChip}
      <button class="cfb view" onclick="event.stopPropagation();collapseCard('${t.id}')">Close</button>
    </div>`;
  } else {
    const doneBtn=t.done
      ? `<button class="cfb undo-done" onclick="event.stopPropagation();toggleDone('${t.id}')">â†© Undo Done</button>`
      : `<button class="cfb mark-done" onclick="event.stopPropagation();toggleDone('${t.id}')">âœ“ Mark Done</button>`;
    expandedFooter=`<div class="card-footer-exp">
      ${doneBtn}
      <span class="cfb-spacer"></span>
      ${creatorChip}
      <button class="cfb view" onclick="event.stopPropagation();collapseCard('${t.id}')">Close</button>
    </div>`;
  }

  return `
  <div class="task-card ${t.done?'done-card':''} ${over&&!t.done?'overdue-card':''} ${t._expanded?'expanded':''}" id="card-${t.id}" data-id="${t.id}">
    <div class="card-top">
      <div class="card-name">${esc(t.name)}</div>
      <span class="badge cat-${t.category}">${CAT_LABELS[t.category]||t.category}</span>
    </div>

    ${due||statusChip?`<div class="card-due-meta">
      ${due?`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      ${esc(due)}`:''}
      ${statusChip}
    </div>`:''}

    <div class="card-desc-collapsed ${!notes?'no-desc':''}" onclick="expandCard('${t.id}')">
      ${esc(notes)||'No description â€” click to view.'}
    </div>

    ${collapsedFooter}

    <div class="card-expanded-body">
      <div class="card-desc-full">${esc(notes)||'<em style="opacity:0.5">No description.</em>'}</div>
      ${(imgHTML||addImgBtn)?`<div class="card-images">${imgHTML}${addImgBtn}</div>`:''}
      ${expandedFooter}
    </div>
  </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EXPAND / COLLAPSE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function expandCard(id){
  tasks.forEach(x=>x._expanded=false);
  const t=tasks.find(x=>x.id===id);if(t)t._expanded=true;
  renderTasks();
  setTimeout(()=>{const el=document.getElementById('card-'+id);if(el)el.scrollIntoView({behavior:'smooth',block:'nearest'});},60);
}
function collapseCard(id){
  const t=tasks.find(x=>x.id===id);if(t)t._expanded=false;
  renderTasks();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TOGGLE DONE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDone(id){
  const t=tasks.find(x=>x.id===id);if(!t)return;
  if(!t.done){
    const card=document.getElementById('card-'+id);
    playCompletion(card,()=>{t.done=true;persist();renderAll();});
  } else {
    t.done=false;persist();renderAll();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DELETE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingDeleteId=null;

function deleteTask(id){
  if(currentRole!=='admin')return;
  const t=tasks.find(x=>x.id===id);
  if(!t)return;
  pendingDeleteId=id;
  document.getElementById('delSubText').textContent=`"${t.name}" will be permanently removed.`;
  document.getElementById('delOverlay').classList.add('open');
}
function confirmDelete(){
  if(!pendingDeleteId)return;
  tasks=tasks.filter(t=>t.id!==pendingDeleteId);
  pendingDeleteId=null;
  closeDelModal();
  persist();
  renderAll();
}
function closeDelModal(){
  document.getElementById('delOverlay').classList.remove('open');
  pendingDeleteId=null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  IMAGES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerImgUpload(id){uploadTargetId=id;document.getElementById('imgUpload').click();}
function handleImgUpload(e){
  const files=[...e.target.files];
  const t=tasks.find(x=>x.id===uploadTargetId);if(!t)return;
  if(!t.images)t.images=[];
  let loaded=0;
  files.forEach(f=>{
    const reader=new FileReader();
    reader.onload=ev=>{t.images.push(ev.target.result);loaded++;if(loaded===files.length){persist();renderTasks();}};
    reader.readAsDataURL(f);
  });
  e.target.value='';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LIGHTBOX
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLightbox(id,idx){
  const t=tasks.find(x=>x.id===id);if(!t||!t.images[idx])return;
  document.getElementById('lightboxImg').src=t.images[idx];
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox(){document.getElementById('lightbox').classList.remove('open');}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  COMPLETION ANIMATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playCompletion(el,cb){
  if(!el){cb();return;}
  el.classList.add('task-completing');
  const chk=document.createElement('div');chk.className='completion-chk';
  chk.innerHTML=`<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>`;el.appendChild(chk);
  const cols=['var(--green)','var(--amber)','var(--accent)','var(--red)'];
  for(let i=0;i<7;i++){const p=document.createElement('div');p.className='conf-p';p.style.background=cols[Math.floor(Math.random()*cols.length)];p.style.left=`${50+(Math.random()-.5)*60}%`;p.style.top='50%';el.appendChild(p);}
  setTimeout(()=>{chk.remove();el.querySelectorAll('.conf-p').forEach(p=>p.remove());el.classList.remove('task-completing');cb();},580);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id){
  if(currentRole!=='admin')return;
  editId=id||null;
  document.getElementById('modalTitle').textContent=editId?'Edit Task':'Add Task';
  if(editId){
    const t=tasks.find(x=>x.id===editId);
    document.getElementById('fName').value =t.name;
    document.getElementById('fCat').value  =t.category;
    document.getElementById('fDate').value =t.date||'';
    document.getElementById('fTime').value =t.time||'';
    document.getElementById('fNotes').value=t.notes||'';
  } else {
    ['fName','fDate','fTime','fNotes'].forEach(i=>document.getElementById(i).value='');
    document.getElementById('fCat').value='quiz';
  }
  document.getElementById('overlay').classList.add('open');
  setTimeout(()=>document.getElementById('fName').focus(),100);
}
function closeModal(){document.getElementById('overlay').classList.remove('open');editId=null;}
function handleOverlay(e){if(e.target===document.getElementById('overlay'))closeModal();}

function saveTask(){
  const name=document.getElementById('fName').value.trim();
  if(!name){document.getElementById('fName').style.borderColor='var(--red)';document.getElementById('fName').focus();return;}
  document.getElementById('fName').style.borderColor='';
  const data={name,category:document.getElementById('fCat').value,date:document.getElementById('fDate').value,time:document.getElementById('fTime').value,notes:document.getElementById('fNotes').value.trim()};
  if(editId){
    const idx=tasks.findIndex(t=>t.id===editId);
    tasks[idx]={...tasks[idx],...data};
  } else {
    tasks.push({
      id:Date.now().toString(36)+Math.random().toString(36).slice(2,5),
      created:Date.now(),
      images:[],
      done:false,
      _expanded:false,
      createdBy: currentAdminName,
      ...data
    });
  }
  closeModal();persist();renderAll();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NOTES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNoteModal(){
  if(currentRole!=='admin')return;
  document.getElementById('nText').value='';
  document.getElementById('nExpiry').value='3';
  document.getElementById('noteOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('nText').focus(),100);
}
function closeNoteModal(){document.getElementById('noteOverlay').classList.remove('open');}
function handleNoteOverlay(e){if(e.target===document.getElementById('noteOverlay'))closeNoteModal();}
function saveNote(){
  const text=document.getElementById('nText').value.trim();
  if(!text){document.getElementById('nText').style.borderColor='var(--red)';document.getElementById('nText').focus();return;}
  document.getElementById('nText').style.borderColor='';
  const days=parseInt(document.getElementById('nExpiry').value)||3;
  notes.push({
    id:Date.now().toString(36)+Math.random().toString(36).slice(2,4),
    text,
    author:currentAdminName,
    createdAt:Date.now(),
    expiresAt:Date.now()+(days*24*60*60*1000)
  });
  closeNoteModal();persist();renderFeatured();
}
function deleteNote(id){
  notes=notes.filter(n=>n.id!==id);
  persist();renderFeatured();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  KEYBOARD SHORTCUTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closeModal();closeLightbox();closeLoginModal();closeDelModal();closeNoteModal();
  }
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){
    if(document.getElementById('overlay').classList.contains('open'))saveTask();
    if(document.getElementById('loginOverlay').classList.contains('open'))attemptLogin();
    if(document.getElementById('noteOverlay').classList.contains('open'))saveNote();
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('dateBarText').innerHTML=`<span>${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</span>`;

currentRole='user';
updateRoleUI();
load();
</script>
</body>
</html>
